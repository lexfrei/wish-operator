suite: deployment tests
templates:
  - deployment.yaml
tests:
  # Basic structure
  - it: should create deployment with correct name
    asserts:
      - isKind:
          of: Deployment
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-wish-operator

  - it: should use fullnameOverride when set
    set:
      fullnameOverride: my-custom-operator
    asserts:
      - equal:
          path: metadata.name
          value: my-custom-operator

  - it: should have correct labels
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: wish-operator
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm

  # Replicas
  - it: should have 1 replica by default
    asserts:
      - equal:
          path: spec.replicas
          value: 1

  - it: should allow custom replica count
    set:
      replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  # Security - Pod level
  - it: should run as non-root
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true

  - it: should have seccomp profile RuntimeDefault
    asserts:
      - equal:
          path: spec.template.spec.securityContext.seccompProfile.type
          value: RuntimeDefault

  # Security - Container level
  - it: should not allow privilege escalation
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false

  - it: should drop ALL capabilities
    asserts:
      - contains:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          content: ALL

  - it: should have read-only root filesystem
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true

  # Image configuration
  - it: should use correct image repository
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: "^ghcr.io/lexfrei/wish-operator:"

  - it: should use appVersion as default tag
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/lexfrei/wish-operator:0.4.0

  - it: should allow custom image tag
    set:
      image:
        tag: v1.2.3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/lexfrei/wish-operator:v1.2.3

  - it: should allow custom image repository
    set:
      image:
        repository: my-registry.io/wish-operator
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: "^my-registry.io/wish-operator:"

  - it: should use IfNotPresent pull policy by default
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent

  - it: should allow Always pull policy
    set:
      image:
        pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

  # Image pull secrets
  - it: should not have imagePullSecrets by default
    asserts:
      - isNull:
          path: spec.template.spec.imagePullSecrets

  - it: should support imagePullSecrets
    set:
      imagePullSecrets:
        - name: my-registry-secret
    asserts:
      - contains:
          path: spec.template.spec.imagePullSecrets
          content:
            name: my-registry-secret

  # Ports
  - it: should expose http port 8080
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: http
            containerPort: 8080
            protocol: TCP

  - it: should expose health port 8081
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: health
            containerPort: 8081
            protocol: TCP

  # Probes
  - it: should have liveness probe on /healthz
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 15
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 20

  - it: should have readiness probe on /readyz
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /readyz
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: health
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 10

  # Operator arguments
  - it: should bind web server to port 8080
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --web-bind-address=:8080

  - it: should use default namespace
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --web-namespace=default

  - it: should use custom namespace when set
    set:
      operator:
        namespace: wishlist-ns
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --web-namespace=wishlist-ns

  - it: should use default rate limit 30
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --rate-limit=30

  - it: should allow custom rate limit
    set:
      operator:
        rateLimit: 100
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --rate-limit=100

  - it: should use default rate burst 10
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --rate-burst=10

  - it: should allow custom rate burst
    set:
      operator:
        rateBurst: 20
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --rate-burst=20

  - it: should not enable leader election by default
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].args
          content: --leader-elect

  - it: should enable leader election when configured
    set:
      operator:
        leaderElection: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --leader-elect

  # Resources
  - it: should have resource limits
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 128Mi

  - it: should have resource requests
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 10m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 64Mi

  - it: should allow custom resources
    set:
      resources:
        limits:
          cpu: 1000m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 1000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 256Mi

  # Pod annotations and labels
  - it: should not have pod annotations by default
    asserts:
      - isNull:
          path: spec.template.metadata.annotations

  - it: should support pod annotations
    set:
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"

  - it: should support additional pod labels
    set:
      podLabels:
        custom-label: custom-value
    asserts:
      - equal:
          path: spec.template.metadata.labels["custom-label"]
          value: custom-value

  # Scheduling
  - it: should not have nodeSelector by default
    asserts:
      - isNull:
          path: spec.template.spec.nodeSelector

  - it: should support nodeSelector
    set:
      nodeSelector:
        kubernetes.io/os: linux
        node-type: worker
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector["kubernetes.io/os"]
          value: linux
      - equal:
          path: spec.template.spec.nodeSelector["node-type"]
          value: worker

  - it: should not have tolerations by default
    asserts:
      - isNull:
          path: spec.template.spec.tolerations

  - it: should support tolerations
    set:
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "node-role.kubernetes.io/control-plane"
            operator: "Exists"
            effect: "NoSchedule"

  - it: should not have affinity by default
    asserts:
      - isNull:
          path: spec.template.spec.affinity

  - it: should support affinity
    set:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/arch
                    operator: In
                    values:
                      - amd64
                      - arm64
    asserts:
      - isNotNull:
          path: spec.template.spec.affinity.nodeAffinity

  # Service Account
  - it: should use correct service account
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-wish-operator

  - it: should use custom service account name
    set:
      serviceAccount:
        name: my-sa
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: my-sa
