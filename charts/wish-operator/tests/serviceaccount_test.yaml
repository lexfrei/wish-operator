suite: serviceaccount tests
templates:
  - serviceaccount.yaml
tests:
  # Creation conditions
  - it: should create serviceaccount by default
    asserts:
      - isKind:
          of: ServiceAccount
      - isAPIVersion:
          of: v1
      - hasDocuments:
          count: 1

  - it: should not create serviceaccount when disabled
    set:
      serviceAccount:
        create: false
    asserts:
      - hasDocuments:
          count: 0

  # Naming
  - it: should have correct default name
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-wish-operator

  - it: should use custom name when specified
    set:
      serviceAccount:
        name: my-custom-sa
    asserts:
      - equal:
          path: metadata.name
          value: my-custom-sa

  - it: should use fullnameOverride
    set:
      fullnameOverride: custom-operator
    asserts:
      - equal:
          path: metadata.name
          value: custom-operator

  # Labels
  - it: should have correct labels
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: wish-operator
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm

  # Annotations
  - it: should not have annotations by default
    asserts:
      - isNull:
          path: metadata.annotations

  - it: should support custom annotations
    set:
      serviceAccount:
        annotations:
          eks.amazonaws.com/role-arn: arn:aws:iam::123456789:role/my-role
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: arn:aws:iam::123456789:role/my-role

  - it: should support multiple annotations
    set:
      serviceAccount:
        annotations:
          annotation1: value1
          annotation2: value2
    asserts:
      - equal:
          path: metadata.annotations["annotation1"]
          value: value1
      - equal:
          path: metadata.annotations["annotation2"]
          value: value2

  # Automount token
  - it: should automount token by default
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: true

  - it: should allow disabling automount
    set:
      serviceAccount:
        automount: false
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: false
